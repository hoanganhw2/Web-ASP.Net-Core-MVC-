@{
    ViewData["Title"] = "Th·ªëng k√™";
    var monthlyRevenue = ViewBag.MonthlyRevenue as IEnumerable<dynamic> ?? new List<dynamic>();
    var topProducts = ViewBag.TopProducts as IEnumerable<dynamic> ?? new List<dynamic>();
}

<!-- Page Header -->
<div class="page-header d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="page-title">Th·ªëng k√™ & B√°o c√°o</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/admin">Admin</a></li>
                <li class="breadcrumb-item active">Th·ªëng k√™</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row g-4">
    <!-- Revenue Chart -->
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title">Doanh thu theo th√°ng (12 th√°ng g·∫ßn nh·∫•t)</h5>
            </div>
            <div class="card-body">
                <canvas id="revenueChart" height="100"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Top Products -->
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title">Top 10 s·∫£n ph·∫©m b√°n ch·∫°y</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table mb-0">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>S·∫£n ph·∫©m</th>
                                <th class="text-center">S·ªë l∆∞·ª£ng</th>
                                <th class="text-end">Doanh thu</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                var rank = 1;
                            }
                            @foreach (var product in topProducts)
                            {
                                <tr>
                                    <td>
                                        @if (rank == 1)
                                        {
                                            <span class="badge bg-warning text-dark">ü•á 1</span>
                                        }
                                        else if (rank == 2)
                                        {
                                            <span class="badge bg-secondary">ü•à 2</span>
                                        }
                                        else if (rank == 3)
                                        {
                                            <span class="badge bg-danger">ü•â 3</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">@rank</span>
                                        }
                                    </td>
                                    <td>
                                        <strong class="d-block text-truncate" style="max-width: 200px;">@product.BookName</strong>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-primary">@product.TotalQuantity</span>
                                    </td>
                                    <td class="text-end">@String.Format("{0:N0}ƒë", product.TotalRevenue)</td>
                                </tr>
                                rank++;
                            }
                            @if (!topProducts.Any())
                            {
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-4">
                                        Ch∆∞a c√≥ d·ªØ li·ªáu
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Monthly Stats Table -->
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title">Chi ti·∫øt doanh thu theo th√°ng</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table mb-0">
                        <thead>
                            <tr>
                                <th>Th√°ng</th>
                                <th class="text-center">S·ªë ƒë∆°n</th>
                                <th class="text-end">Doanh thu</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in monthlyRevenue)
                            {
                                <tr>
                                    <td>@item.Month/@item.Year</td>
                                    <td class="text-center">
                                        <span class="badge bg-info">@item.OrderCount ƒë∆°n</span>
                                    </td>
                                    <td class="text-end"><strong>@String.Format("{0:N0}ƒë", item.Revenue)</strong></td>
                                </tr>
                            }
                            @if (!monthlyRevenue.Any())
                            {
                                <tr>
                                    <td colspan="3" class="text-center text-muted py-4">
                                        Ch∆∞a c√≥ d·ªØ li·ªáu
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Revenue Chart
        const ctx = document.getElementById('revenueChart').getContext('2d');
        
        const monthlyData = [
            @foreach (var item in monthlyRevenue)
            {
                @:{ month: '@item.Month/@item.Year', revenue: @item.Revenue, orders: @item.OrderCount },
            }
        ];

        const labels = monthlyData.map(d => d.month);
        const revenues = monthlyData.map(d => d.revenue);
        const orders = monthlyData.map(d => d.orders);

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels.length > 0 ? labels : ['Kh√¥ng c√≥ d·ªØ li·ªáu'],
                datasets: [{
                    label: 'Doanh thu (VNƒê)',
                    data: revenues.length > 0 ? revenues : [0],
                    backgroundColor: 'rgba(79, 70, 229, 0.8)',
                    borderRadius: 8,
                    yAxisID: 'y'
                }, {
                    label: 'S·ªë ƒë∆°n h√†ng',
                    data: orders.length > 0 ? orders : [0],
                    type: 'line',
                    borderColor: '#22c55e',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    borderWidth: 3,
                    pointBackgroundColor: '#22c55e',
                    pointRadius: 5,
                    yAxisID: 'y1',
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                if (context.datasetIndex === 0) {
                                    return 'Doanh thu: ' + new Intl.NumberFormat('vi-VN').format(context.raw) + 'ƒë';
                                }
                                return 'S·ªë ƒë∆°n: ' + context.raw;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Doanh thu (VNƒê)'
                        },
                        ticks: {
                            callback: function(value) {
                                return new Intl.NumberFormat('vi-VN', { notation: 'compact' }).format(value);
                            }
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'S·ªë ƒë∆°n h√†ng'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                    },
                }
            }
        });
    </script>
}
