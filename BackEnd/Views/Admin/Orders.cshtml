@model List<BackEnd.Models.Entity.Order>
@{
    ViewData["Title"] = "Quản lý Đơn hàng";
    var currentStatus = ViewBag.CurrentStatus as int?;
}

<!-- Page Header -->
<div class="page-header d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="page-title">Quản lý Đơn hàng</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/admin">Admin</a></li>
                <li class="breadcrumb-item active">Đơn hàng</li>
            </ol>
        </nav>
    </div>
</div>

<!-- Status Filter Tabs -->
<div class="card mb-4">
    <div class="card-body py-2">
        <ul class="nav nav-pills">
            <li class="nav-item">
                <a class="nav-link @(currentStatus == null ? "active" : "")" href="/admin/orders">
                    <i class="fas fa-list me-2"></i>Tất cả
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link @(currentStatus == 0 ? "active" : "")" href="/admin/orders?status=0">
                    <i class="fas fa-clock me-2"></i>Chờ xác nhận
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link @(currentStatus == 1 ? "active" : "")" href="/admin/orders?status=1">
                    <i class="fas fa-truck me-2"></i>Đang giao
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link @(currentStatus == 2 ? "active" : "")" href="/admin/orders?status=2">
                    <i class="fas fa-check-circle me-2"></i>Hoàn thành
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link @(currentStatus == 3 ? "active" : "")" href="/admin/orders?status=3">
                    <i class="fas fa-times-circle me-2"></i>Đã hủy
                </a>
            </li>
        </ul>
    </div>
</div>

<!-- Orders List -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title">Danh sách đơn hàng (@Model.Count)</h5>
        <div class="input-group" style="width: 250px;">
            <input type="text" id="searchInput" class="form-control" placeholder="Tìm đơn hàng...">
            <button class="btn btn-outline-secondary" type="button">
                <i class="fas fa-search"></i>
            </button>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table" id="ordersTable">
                <thead>
                    <tr>
                        <th>Mã đơn</th>
                        <th>Ngày đặt</th>
                        <th>Địa chỉ giao</th>
                        <th>SĐT</th>
                        <th>Số SP</th>
                        <th>Tổng tiền</th>
                        <th>Trạng thái</th>
                        <th style="width: 180px;">Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Count == 0)
                    {
                        <tr>
                            <td colspan="8" class="text-center text-muted py-4">
                                <i class="fas fa-inbox fa-2x mb-2"></i><br>
                                Không có đơn hàng nào
                            </td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var order in Model)
                        {
                            var statusClass = order.Status switch
                            {
                                0 => "bg-warning",
                                1 => "bg-info",
                                2 => "bg-success",
                                3 => "bg-danger",
                                _ => "bg-secondary"
                            };
                            var statusText = order.Status switch
                            {
                                0 => "Chờ xác nhận",
                                1 => "Đang giao",
                                2 => "Hoàn thành",
                                3 => "Đã hủy",
                                _ => "Không xác định"
                            };
                            var itemCount = order.OrderItems?.Count ?? 0;
                            
                            <tr>
                                <td><strong>#@order.Id</strong></td>
                                <td>@order.OrderDate.ToString("dd/MM/yyyy")<br><small class="text-muted">@order.OrderDate.ToString("HH:mm")</small></td>
                                <td class="text-truncate" style="max-width: 150px;" title="@order.ShippingAddress">@order.ShippingAddress</td>
                                <td>@order.PhoneNumber</td>
                                <td><span class="badge bg-light text-dark">@itemCount SP</span></td>
                                <td><strong>@String.Format("{0:N0}đ", order.TotalAmount)</strong></td>
                                <td>
                                    <span class="badge @statusClass">@statusText</span>
                                </td>
                                <td>
                                    <a href="/admin/orders/details/@order.Id" class="btn btn-sm btn-outline-primary me-1" title="Chi tiết">
                                        <i class="fas fa-eye me-1"></i>Chi tiết
                                    </a>
                                    @if (order.Status == 0)
                                    {
                                        <div class="btn-group">
                                            <button type="button" class="btn btn-sm btn-success dropdown-toggle" data-bs-toggle="dropdown">
                                                <i class="fas fa-check me-1"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="#" onclick="updateOrderStatus(@order.Id, 1)"><i class="fas fa-truck me-2"></i>Xác nhận & Giao hàng</a></li>
                                                <li><a class="dropdown-item text-danger" href="#" onclick="updateOrderStatus(@order.Id, 3)"><i class="fas fa-times me-2"></i>Hủy đơn</a></li>
                                            </ul>
                                        </div>
                                    }
                                    else if (order.Status == 1)
                                    {
                                        <button class="btn btn-sm btn-success" onclick="updateOrderStatus(@order.Id, 2)" title="Đánh dấu hoàn thành">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    }
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
    <!-- Pagination -->
    <div class="card-footer d-flex justify-content-between align-items-center">
        <div class="text-muted">
            Hiển thị <span id="showingStart">1</span>-<span id="showingEnd">10</span> trong <span id="totalItems">@Model.Count</span> đơn hàng
        </div>
        <nav>
            <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
        </nav>
    </div>
</div>

@section Scripts {
    <script>
        const itemsPerPage = 10;
        let currentPage = 1;
        let allRows = [];
        let filteredRows = [];

        document.addEventListener('DOMContentLoaded', function() {
            allRows = Array.from(document.querySelectorAll('#ordersTable tbody tr'));
            filteredRows = allRows;
            renderPagination();
            showPage(1);
        });

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', function() {
            const filter = this.value.toLowerCase();
            filteredRows = allRows.filter(row => row.textContent.toLowerCase().includes(filter));
            currentPage = 1;
            renderPagination();
            showPage(1);
        });

        function showPage(page) {
            currentPage = page;
            const start = (page - 1) * itemsPerPage;
            const end = start + itemsPerPage;

            allRows.forEach(row => row.style.display = 'none');
            filteredRows.slice(start, end).forEach(row => row.style.display = '');

            document.getElementById('showingStart').textContent = filteredRows.length > 0 ? start + 1 : 0;
            document.getElementById('showingEnd').textContent = Math.min(end, filteredRows.length);
            document.getElementById('totalItems').textContent = filteredRows.length;

            updatePaginationUI();
        }

        function renderPagination() {
            const totalPages = Math.ceil(filteredRows.length / itemsPerPage);
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            if (totalPages <= 1) return;

            // Previous
            pagination.innerHTML += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="showPage(${currentPage - 1}); return false;">«</a>
            </li>`;

            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    pagination.innerHTML += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="showPage(${i}); return false;">${i}</a>
                    </li>`;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    pagination.innerHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }

            // Next
            pagination.innerHTML += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="showPage(${currentPage + 1}); return false;">»</a>
            </li>`;
        }

        function updatePaginationUI() {
            const totalPages = Math.ceil(filteredRows.length / itemsPerPage);
            document.querySelectorAll('#pagination .page-item').forEach((item, index) => {
                const pageNum = parseInt(item.querySelector('.page-link')?.textContent);
                if (!isNaN(pageNum)) {
                    item.classList.toggle('active', pageNum === currentPage);
                }
            });
        }

        function updateOrderStatus(orderId, status) {
            const statusText = {
                1: 'Đang giao',
                2: 'Hoàn thành',
                3: 'Đã hủy'
            };
            
            const btnClass = status === 3 ? 'btn-danger' : 'btn-success';

            showConfirm(
                `Bạn có chắc chắn muốn cập nhật trạng thái đơn hàng <strong>#${orderId}</strong> thành "<strong>${statusText[status]}</strong>"?`,
                function() {
                    fetch('/admin/orders/update-status', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `orderId=${orderId}&status=${status}`
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showToast(data.message, 'success');
                            setTimeout(() => location.reload(), 1000);
                        } else {
                            showToast(data.message, 'error');
                        }
                    });
                },
                { 
                    title: 'Xác nhận cập nhật', 
                    confirmText: 'Cập nhật',
                    btnClass: btnClass
                }
            );
        }
    </script>
}
