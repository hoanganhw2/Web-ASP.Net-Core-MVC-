@using BackEnd.Models.Entity
@{
    ViewData["Title"] = "Sản phẩm";
    var categories = ViewBag.Categories as List<Category> ?? new List<Category>();
    var books = ViewBag.Books as List<Book> ?? new List<Book>();
    var currentPage = ViewBag.CurrentPage as int? ?? 1;
    var totalPages = ViewBag.TotalPages as int? ?? 1;
    var totalItems = ViewBag.TotalItems as int? ?? 0;
    var currentSort = ViewBag.CurrentSort as string ?? "newest";
    var subcategoryId = ViewBag.SubcategoryId as int?;
    var categoryId = ViewBag.CategoryId as int?;
    var currentSubcategory = ViewBag.CurrentSubcategory as SubCategory;
    var currentCategory = ViewBag.CurrentCategory as Category;
}

<div class="products-page">
    <div class="breadcrumb-shop">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <ol class="breadcrumb breadcrumb-arrows">
                        <li><a href="/">Trang chủ</a></li>
                        <li class="active">
                            @if (currentSubcategory != null)
                            {
                                <text>@currentSubcategory.Name</text>
                            }
                            else if (currentCategory != null)
                            {
                                <text>@currentCategory.Name</text>
                            }
                            else
                            {
                                <text>Tất cả sản phẩm</text>
                            }
                        </li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <div class="container py-4">
        <div class="row">
            <!-- Sidebar Filter - 3 columns -->
            <div class="col-12 col-lg-3">
                <div class="filter-sidebar">
                    <!-- Danh mục -->
                    <div class="filter-box mb-4">
                        <h5 class="filter-title">
                            <i class="fa-solid fa-list me-2"></i>Danh mục
                        </h5>
                        <div class="filter-content">
                            <ul class="category-list">
                                <li class="@(subcategoryId == null && categoryId == null ? "active" : "")">
                                    <a href="/products">Tất cả sản phẩm</a>
                                </li>
                                @foreach (var cat in categories)
                                {
                                    <li class="category-parent @(categoryId == cat.Id ? "active" : "")">
                                        <a href="/products?category=@cat.Id">
                                            @cat.Name
                                            <i class="fa-solid fa-chevron-down toggle-subcategory"></i>
                                        </a>
                                        <ul class="subcategory-list @(categoryId == cat.Id || cat.subCategories.Any(s => s.Id == subcategoryId) ? "show" : "")">
                                            @foreach (var sub in cat.subCategories)
                                            {
                                                <li class="@(subcategoryId == sub.Id ? "active" : "")">
                                                    <a href="/products?subcategory=@sub.Id">@sub.Name</a>
                                                </li>
                                            }
                                        </ul>
                                    </li>
                                }
                            </ul>
                        </div>
                    </div>

                    <!-- Khoảng giá -->
                    <div class="filter-box mb-4">
                        <h5 class="filter-title">
                            <i class="fa-solid fa-tags me-2"></i>Khoảng giá
                        </h5>
                        <div class="filter-content">
                            <div class="price-range-filter">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="small text-muted">0đ</span>
                                    <span class="small text-muted">1,000,000đ</span>
                                </div>
                                <div class="d-flex gap-2 mb-3">
                                    <input type="number" class="form-control form-control-sm" id="minPrice" 
                                           placeholder="Từ" min="0" step="10000">
                                    <span class="align-self-center">-</span>
                                    <input type="number" class="form-control form-control-sm" id="maxPrice" 
                                           placeholder="Đến" min="0" step="10000">
                                </div>
                                <button type="button" class="btn btn-primary btn-sm w-100" id="applyPriceFilter">
                                    <i class="fa-solid fa-filter me-1"></i>Lọc theo giá
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Products - 9 columns -->
            <div class="col-12 col-lg-9">
                <!-- Header -->
                <div class="products-header d-flex justify-content-between align-items-center mb-4">
                    <div class="products-count">
                        <span class="text-muted">Hiển thị <strong>@books.Count</strong> / <strong>@totalItems</strong> sản phẩm</span>
                    </div>
                    <div class="products-sort d-flex align-items-center">
                        <label class="me-2 text-muted">Sắp xếp:</label>
                        <select class="form-select form-select-sm" id="sortSelect" style="width: auto;">
                            @if (currentSort == "newest")
                            {
                                <option value="newest" selected>Mới nhất</option>
                            }
                            else
                            {
                                <option value="newest">Mới nhất</option>
                            }
                            @if (currentSort == "price-asc")
                            {
                                <option value="price-asc" selected>Giá: Thấp - Cao</option>
                            }
                            else
                            {
                                <option value="price-asc">Giá: Thấp - Cao</option>
                            }
                            @if (currentSort == "price-desc")
                            {
                                <option value="price-desc" selected>Giá: Cao - Thấp</option>
                            }
                            else
                            {
                                <option value="price-desc">Giá: Cao - Thấp</option>
                            }
                            @if (currentSort == "name-asc")
                            {
                                <option value="name-asc" selected>Tên: A - Z</option>
                            }
                            else
                            {
                                <option value="name-asc">Tên: A - Z</option>
                            }
                            @if (currentSort == "name-desc")
                            {
                                <option value="name-desc" selected>Tên: Z - A</option>
                            }
                            else
                            {
                                <option value="name-desc">Tên: Z - A</option>
                            }
                            @if (currentSort == "discount")
                            {
                                <option value="discount" selected>Giảm giá nhiều</option>
                            }
                            else
                            {
                                <option value="discount">Giảm giá nhiều</option>
                            }
                        </select>
                    </div>
                </div>

                <!-- Products Grid -->
                @if (books.Count == 0)
                {
                    <div class="text-center py-5">
                        <i class="fa-solid fa-book" style="font-size: 80px; color: #ccc;"></i>
                        <h4 class="mt-4 text-muted">Không tìm thấy sản phẩm</h4>
                        <p class="text-muted">Hãy thử lọc theo danh mục khác!</p>
                        <a href="/products" class="btn btn-primary mt-3">Xem tất cả sản phẩm</a>
                    </div>
                }
                else
                {
                    <div class="row">
                        @foreach (var book in books)
                        {
                            var image = book.Images?.FirstOrDefault();
                            var imagePath = image != null ? Url.Content("~/img/product/" + image.Path) : Url.Content("~/img/default-book.jpg");
                            var discountPercent = book.Price > 0 ? Math.Round((book.Price - book.Price_Discount) / book.Price * 100) : 0;
                            
                            <div class="col-6 col-md-4 col-xl-3 mb-4">
                                <div class="product-card">
                                    <div class="product-image">
                                        <a href="/products/@book.Id">
                                            <img src="@imagePath" alt="@book.Name" class="img-fluid">
                                        </a>
                                        @if (discountPercent > 0)
                                        {
                                            <span class="discount-badge">-@discountPercent%</span>
                                        }
                                        <div class="product-actions">
                                            <button type="button" class="btn-add-wishlist" data-book-id="@book.Id" title="Thêm yêu thích">
                                                <i class="fa-solid fa-heart"></i>
                                            </button>
                                            <button type="button" class="btn-add-cart" data-book-id="@book.Id" title="Thêm vào giỏ">
                                                <i class="fa-solid fa-cart-plus"></i>
                                            </button>
                                            <a href="/products/@book.Id" class="btn-view" title="Xem chi tiết">
                                                <i class="fa-solid fa-eye"></i>
                                            </a>
                                        </div>
                                    </div>
                                    <div class="product-info">
                                        <h6 class="product-name" style="height:100%;">
                                            <a href="/products/@book.Id">@book.Name</a>
                                        </h6>
                                        <div class="product-price">
                                            @if (book.Price_Discount < book.Price)
                                            {
                                                <span class="price-old">@String.Format("{0:N0}", book.Price)đ</span>
                                                <span class="price-current">@String.Format("{0:N0}", book.Price_Discount)đ</span>
                                            }
                                            else
                                            {
                                                <span class="price-current">@String.Format("{0:N0}", book.Price)đ</span>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>

                    <!-- Pagination -->
                    @if (totalPages > 1)
                    {
                        <nav class="d-flex justify-content-center mt-4">
                            <ul class="pagination">
                                @if (currentPage > 1)
                                {
                                    <li class="page-item">
                                        <a class="page-link" href="@GetPageUrl(currentPage - 1)">&laquo;</a>
                                    </li>
                                }
                                
                                @for (int i = 1; i <= totalPages; i++)
                                {
                                    if (i == 1 || i == totalPages || (i >= currentPage - 2 && i <= currentPage + 2))
                                    {
                                        <li class="page-item @(i == currentPage ? "active" : "")">
                                            <a class="page-link" href="@GetPageUrl(i)">@i</a>
                                        </li>
                                    }
                                    else if (i == currentPage - 3 || i == currentPage + 3)
                                    {
                                        <li class="page-item disabled"><span class="page-link">...</span></li>
                                    }
                                }
                                
                                @if (currentPage < totalPages)
                                {
                                    <li class="page-item">
                                        <a class="page-link" href="@GetPageUrl(currentPage + 1)">&raquo;</a>
                                    </li>
                                }
                            </ul>
                        </nav>
                    }
                }
            </div>
        </div>
    </div>
</div>

@functions {
    string GetPageUrl(int page)
    {
        var url = "/products?page=" + page;
        if (ViewBag.SubcategoryId != null)
        {
            url += "&subcategory=" + ViewBag.SubcategoryId;
        }
        if (ViewBag.CategoryId != null)
        {
            url += "&category=" + ViewBag.CategoryId;
        }
        if (!string.IsNullOrEmpty(ViewBag.CurrentSort))
        {
            url += "&sort=" + ViewBag.CurrentSort;
        }
        return url;
    }
}

<style>
    /* Filter Sidebar */
    .filter-sidebar {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
    }
    .filter-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #dee2e6;
    }
    .category-list, .subcategory-list, .price-filter {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    .category-list > li {
        margin-bottom: 5px;
    }
    .category-list > li > a {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        color: #333;
        text-decoration: none;
        border-radius: 4px;
        transition: all 0.2s;
    }
    .category-list > li > a:hover,
    .category-list > li.active > a {
        background: #0d6efd;
        color: white;
    }
    .subcategory-list {
        display: none;
        padding-left: 20px;
        margin-top: 5px;
    }
    .subcategory-list.show {
        display: block;
    }
    .subcategory-list li a {
        display: block;
        padding: 6px 12px;
        color: #666;
        text-decoration: none;
        font-size: 14px;
    }
    .subcategory-list li a:hover,
    .subcategory-list li.active a {
        color: #0d6efd;
        background: rgba(13, 110, 253, 0.1);
        border-radius: 4px;
    }
    .price-filter li a {
        display: block;
        padding: 6px 0;
        color: #666;
        text-decoration: none;
        font-size: 14px;
    }
    .price-filter li a:hover {
        color: #0d6efd;
    }
    
    /* Product Card */
    .product-card {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        transition: transform 0.3s, box-shadow 0.3s;
    }
    .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    .product-image {
        position: relative;
        padding-top: 130%;
        overflow: hidden;
    }
    .product-image img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s;
    }
    .product-card:hover .product-image img {
        transform: scale(1.05);
    }
    .discount-badge {
        position: absolute;
        top: 10px;
        left: 10px;
        background: #dc3545;
        color: white;
        padding: 4px 10px;
        font-size: 12px;
        font-weight: bold;
        border-radius: 4px;
    }
    .product-actions {
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 8px;
        opacity: 0;
        transition: opacity 0.3s;
    }
    .product-card:hover .product-actions {
        opacity: 1;
    }
    .product-actions button,
    .product-actions a {
        width: 36px;
        height: 36px;
        border: none;
        border-radius: 50%;
        background: white;
        color: #333;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .product-actions button:hover,
    .product-actions a:hover {
        background: #0d6efd;
        color: white;
    }
    .product-info {
        padding: 15px;
    }
    .product-name {
        font-size: 14px;
        margin-bottom: 8px;
        height: 40px;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        text-overflow: ellipsis;
        word-break: break-word;
    }
    .product-name a {
        color: #333;
        text-decoration: none;
    }
    .product-name a:hover {
        color: #0d6efd;
    }
    .price-old {
        text-decoration: line-through;
        color: #999;
        font-size: 13px;
        margin-right: 8px;
    }
    .price-current {
        color: #dc3545;
        font-weight: bold;
        font-size: 15px;
    }
</style>

@section Scripts {
<script>
    $(document).ready(function() {
        // Sắp xếp
        $('#sortSelect').on('change', function() {
            var sort = $(this).val();
            var url = new URL(window.location.href);
            url.searchParams.set('sort', sort);
            url.searchParams.set('page', '1');
            window.location.href = url.toString();
        });

        // Toggle subcategory
        $('.toggle-subcategory').on('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            $(this).closest('.category-parent').find('.subcategory-list').toggleClass('show');
        });

        // Thêm vào giỏ hàng
        $('.btn-add-cart').on('click', function() {
            var bookId = $(this).data('book-id');
            $.ajax({
                url: '/cart/add-ajax',
                type: 'POST',
                data: { bookId: bookId, quantity: 1 },
                success: function(response) {
                    if (response.success) {
                        toastr.success(response.message);
                        updateCartBadge(response.cartCount);
                        refreshCartDropdown();
                    }
                },
                error: function() {
                    toastr.error('Có lỗi xảy ra!');
                }
            });
        });

        // Thêm vào yêu thích
        $('.btn-add-wishlist').on('click', function() {
            var bookId = $(this).data('book-id');
            addToWishlist(bookId);
        });

        // Lọc theo giá
        $('#applyPriceFilter').on('click', function() {
            var minPrice = $('#minPrice').val();
            var maxPrice = $('#maxPrice').val();
            
            if (!minPrice && !maxPrice) {
                toastr.warning('Vui lòng nhập khoảng giá cần lọc!');
                return;
            }
            
            var url = new URL(window.location.href);
            url.searchParams.set('page', '1');
            
            if (minPrice) {
                url.searchParams.set('minPrice', minPrice);
            } else {
                url.searchParams.delete('minPrice');
            }
            
            if (maxPrice) {
                url.searchParams.set('maxPrice', maxPrice);
            } else {
                url.searchParams.delete('maxPrice');
            }
            
            window.location.href = url.toString();
        });

        // Đọc giá trị từ URL và điền vào input
        var urlParams = new URLSearchParams(window.location.search);
        var minPriceParam = urlParams.get('minPrice');
        var maxPriceParam = urlParams.get('maxPrice');
        if (minPriceParam) $('#minPrice').val(minPriceParam);
        if (maxPriceParam) $('#maxPrice').val(maxPriceParam);
    });
</script>
}
